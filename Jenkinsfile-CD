pipeline {
    agent any
    environment {
        GITHUB_REPO = 'https://github.com/Arjun7443/DevopsProject1.git' // Replace with your GitHub repo
        GITHUB_BRANCH = 'main' // Replace with the branch you want to pull from
        NODE_IP = ""
        EC2_NAME = ""
    }

    stages {
        stage("1. Pull Files") {
            steps {
                sshagent(['my_ec2_creds']) {
                    echo "Cloning deployment files from GitHub to ${NODE_IP}..."
                    sh """
                        ssh -o StrictHostKeyChecking=no ${EC2_NAME}@${NODE_IP} << EOF
                            # Navigate to the directory where you want to clone the repo
                            cd /home/ubuntu/
                            # Remove any existing repo folder if necessary
                            rm -rf your-repo-folder || true
                            # Clone the repo from GitHub
                            git clone -b ${GITHUB_BRANCH} ${GITHUB_REPO} your-repo-folder
                        EOF
                    """
                }
            }
        }

        stage('2. Approval') {
            steps {

                input message: 'Approve deployment?'
            }
        }

        stage("3. Deployment") {
            steps {
                sshagent(['my_ec2_creds']) {
                    echo "Deploying to ${NODE_IP}..."
                    sh """
                        ssh -o StrictHostKeyChecking=no ${EC2_NAME}@${NODE_IP} << EOF
                            cd /home/ubuntu/your-repo-folder/manifests
                            kubectl apply -f deployment.yaml
                            kubectl apply -f service.yaml
                            kubectl rollout restart deploy
                            kubectl get service
                        EOF
                    """
                }
            }
        }
    }
}
